<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPB Bulk Dye Solution Calculate Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            color: #1f2937;
        }
        
        /* Unified card style */
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        @media (min-width: 640px) {
            .section-card {
                padding: 1.5rem;
            }
        }
        
        /* Unified section header */
        .section-header {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
        }
        
        @media (min-width: 640px) {
            .section-header {
                font-size: 1.25rem;
                margin-bottom: 1.25rem;
            }
        }
        
        /* Unified input style */
        .input-field {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            color: #1f2937;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-field::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }
        
        @media (min-width: 640px) {
            .input-field {
                padding: 0.75rem 1rem;
                font-size: 0.9375rem;
            }
        }
        
        /* Unified label style */
        .input-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
            letter-spacing: -0.01em;
        }
        
        @media (min-width: 640px) {
            .input-label {
                font-size: 0.875rem;
            }
        }
        
        /* Unified info box */
        .info-box {
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid;
            font-weight: 500;
        }
        
        @media (min-width: 640px) {
            .info-box {
                padding: 0.875rem 1rem;
            }
        }
        
        /* Unified table styles */
        table {
            font-size: 0.875rem;
        }
        
        .table-header {
            background: #f9fafb;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #374151;
            letter-spacing: 0.025em;
        }
        
        @media (min-width: 640px) {
            .table-header {
                font-size: 0.875rem;
            }
        }
        
        table td {
            font-size: 0.875rem;
            color: #1f2937;
        }
        
        table td input {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        table td.font-semibold {
            font-weight: 600;
            color: #111827;
        }
        
        /* Number display emphasis */
        .number-display {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }
        .tooltip {
            position: absolute;
            display: none;
            z-index: 1000;
        }
        .tooltip.show {
            display: block;
        }
        @media (max-width: 768px) {
            .tooltip {
                position: fixed;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%);
                width: 90vw !important;
                max-width: 320px;
            }
            input[type="number"], input[type="text"], select {
                font-size: 16px;
            }
            body {
                font-size: 15px;
            }
            .section-card {
                padding: 1rem;
            }
            .section-header {
                font-size: 1.125rem;
                margin-bottom: 0.875rem;
            }
            table {
                font-size: 0.8125rem;
            }
            .input-field {
                padding: 0.75rem;
                font-size: 16px;
            }
            
            /* Mobile table input optimization */
            #dyeTableBody input[type="text"],
            #dyeTableBody input[type="number"] {
                font-size: 14px !important;
                padding: 0.375rem !important;
            }
            
            #dyeTableBody td:first-child {
                width: 35% !important;
            }
            
            #dyeTableBody input[type="text"] {
                font-size: 13px !important;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .hidden {
            display: none;
        }
        input[type="number"], input[type="text"], select {
            transition: all 0.2s ease;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .section-card {
            transition: box-shadow 0.2s ease;
        }
        .section-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        table th, table td {
            border: 1px solid #e2e8f0;
        }
        table th:first-child, table td:first-child {
            border-left: 1px solid #e2e8f0;
        }
        table thead tr:first-child th:first-child {
            border-top-left-radius: 0.375rem;
        }
        table thead tr:first-child th:last-child {
            border-top-right-radius: 0.375rem;
        }
        @media (min-width: 640px) {
            .grid-responsive {
                display: grid;
                gap: 1rem;
            }
        }
        @media print {
            body {
                background: white;
            }
            .print\:hidden {
                display: none !important;
            }
            #workOrderSection {
                page-break-inside: avoid;
                box-shadow: none;
                border: 2px solid #000;
                max-width: 100%;
                margin: 0;
                padding: 20mm;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }
        
        /* Mobile Work Order Optimization */
        @media (max-width: 768px) {
            /* Show download button on mobile */
            #workOrderSection button {
                display: flex !important;
            }
            
            #workOrderSection {
                padding: 0.5rem !important;
                border-width: 1px !important;
            }
            
            /* Compact header */
            #workOrderSection .flex.items-center.justify-between {
                margin-bottom: 0.5rem !important;
            }
            
            #workOrderSection h2 {
                font-size: 0.875rem !important;
            }
            
            #workOrderSection .w-1\.5 {
                display: none !important;
            }
            
            /* Make header info more compact - 2 columns */
            #workOrderSection .mb-4.p-4.bg-gray-50 {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            #workOrderSection .mb-4.p-4.bg-gray-50 .grid-cols-2 {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.25rem 0.5rem !important;
            }
            
            #workOrderSection .mb-4.p-4.bg-gray-50 .flex {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0 !important;
            }
            
            #workOrderSection .mb-4.p-4.bg-gray-50 .flex .w-24 {
                width: auto !important;
                font-weight: 600;
                font-size: 0.65rem !important;
                color: #6b7280;
                line-height: 1.2;
            }
            
            #workOrderSection .mb-4.p-4.bg-gray-50 .flex .font-semibold {
                font-size: 0.75rem !important;
                line-height: 1.3;
            }
            
            /* Solution summary - compact */
            #workOrderSection .mb-4.grid.grid-cols-3 {
                margin-bottom: 0.5rem !important;
                gap: 0.375rem !important;
            }
            
            #workOrderSection .grid-cols-3 .p-3 {
                padding: 0.375rem !important;
            }
            
            #workOrderSection .grid-cols-3 .text-xs {
                font-size: 0.6rem !important;
                margin-bottom: 0.125rem !important;
                line-height: 1.2;
                white-space: nowrap !important;
            }
            
            #workOrderSection .grid-cols-3 .text-lg {
                font-size: 0.8rem !important;
                line-height: 1.2;
                white-space: nowrap !important;
            }
            
            /* Hide detailed theoretical note on mobile */
            #workOrderSection #woTheoreticalNote {
                font-size: 0.6rem !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 0 !important;
                line-height: 1.3 !important;
            }
            
            /* Compact tables */
            #workOrderSection .mb-4 {
                margin-bottom: 0.5rem !important;
            }
            
            #workOrderSection h3 {
                font-size: 0.75rem !important;
                margin-bottom: 0.375rem !important;
                white-space: nowrap !important;
            }
            
            #workOrderSection table {
                font-size: 0.65rem;
            }
            
            #workOrderSection table th,
            #workOrderSection table td {
                padding: 0.2rem !important;
                line-height: 1.3;
                white-space: nowrap !important;
            }
            
            #workOrderSection table th {
                white-space: normal !important;
            }
            
            /* Smaller font for recipe values to prevent wrapping */
            #workOrderSection table td {
                font-size: 0.6rem !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen py-4 sm:py-8">
    <div class="w-full max-w-7xl mx-auto px-3 sm:px-6">
        <div class="bg-white rounded-xl shadow-xl p-4 sm:p-8">
            <!-- Header -->
            <div class="flex items-center gap-3 sm:gap-4 mb-6 sm:mb-8 pb-4 sm:pb-6 border-b-2 border-blue-100">
                <div class="bg-blue-100 p-2 sm:p-3 rounded-lg">
                    <svg class="w-7 h-7 sm:w-9 sm:h-9 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl sm:text-3xl font-bold text-gray-800">CPB Dye Solution Calculator</h1>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1">Cold Pad Batch Process</p>
                </div>
            </div>

            <!-- Load Recipe Section -->
            <div class="section-card mb-5 sm:mb-6 bg-gradient-to-r from-teal-50 to-cyan-50">
                <div class="flex items-center gap-3 mb-3">
                    <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    <h2 class="text-base sm:text-lg font-bold text-gray-800">Load Saved Recipe</h2>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <select id="savedRecipes" onchange="loadRecipe()" class="flex-1 input-field bg-white">
                        <option value="">-- Select a saved recipe --</option>
                    </select>
                    <button onclick="deleteRecipe()" class="px-4 py-2.5 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        <span class="hidden sm:inline">Delete</span>
                    </button>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="section-card mb-5 sm:mb-6">
                <h2 class="section-header">
                    <span class="w-1 h-5 bg-purple-500 rounded-full"></span>
                    Order Information
                </h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div>
                        <label class="input-label">Customer</label>
                        <input type="text" id="customerName" placeholder="Customer Name" oninput="updateWorkOrder()" class="input-field">
                    </div>
                    <div>
                        <label class="input-label">Color</label>
                        <input type="text" id="colorName" placeholder="Color Name" oninput="updateWorkOrder()" class="input-field">
                    </div>
                    <div>
                        <label class="input-label">Fabric Type</label>
                        <input type="text" id="fabricType" placeholder="e.g. 100% Cotton" oninput="updateWorkOrder()" class="input-field">
                    </div>
                    <div>
                        <label class="input-label">Order No.</label>
                        <input type="text" id="orderNo" placeholder="Order Number" oninput="updateWorkOrder()" class="input-field">
                    </div>
                </div>
            </div>

            <!-- Fabric Information -->
            <div class="section-card mb-5 sm:mb-6">
                <h2 class="section-header">
                    <span class="w-1 h-5 bg-yellow-500 rounded-full"></span>
                    Fabric Information
                </h2>
                
                <div class="mb-3 sm:mb-4">
                    <label class="input-label">Calculation Mode</label>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                        <label class="flex items-center text-sm cursor-pointer hover:text-blue-600 transition-colors">
                            <input type="radio" name="fabricMode" value="direct" checked onchange="updateFabricMode()" class="mr-2 w-4 h-4">
                            <span>Direct Input (kg)</span>
                        </label>
                        <label class="flex items-center text-sm cursor-pointer hover:text-blue-600 transition-colors">
                            <input type="radio" name="fabricMode" value="calculate" onchange="updateFabricMode()" class="mr-2 w-4 h-4">
                            <span>Calculate (Fabric Weight × Length)</span>
                        </label>
                    </div>
                </div>
                
                <div id="directMode">
                    <label class="input-label">Total Fabric Quantity (kg)</label>
                    <input type="number" id="fabricQuantity" value="1000" oninput="calculate()" class="input-field">
                </div>
                
                <div id="calculateMode" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="input-label">Fabric Weight (g/m)</label>
                        <input type="number" id="fabricWeight" value="500" oninput="calculate()" class="input-field">
                    </div>
                    <div>
                        <label class="input-label">Fabric Length (m)</label>
                        <input type="number" id="fabricLength" value="1000" oninput="calculate()" class="input-field">
                    </div>
                    <div class="col-span-1 sm:col-span-2 info-box bg-blue-50 border-blue-200">
                        <span class="font-semibold text-gray-700">Total Fabric: </span>
                        <span id="calculatedFabric" class="text-lg font-bold text-blue-600">500.00 kg</span>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="input-label">Pick up (%)</label>
                    <input type="number" id="pickUp" value="100" oninput="calculate()" class="input-field">
                </div>
            </div>

            <!-- Solution Preparation -->
            <div class="section-card mb-5 sm:mb-6">
                <h2 class="section-header">
                    <span class="w-1 h-5 bg-cyan-500 rounded-full"></span>
                    Solution Preparation
                </h2>
                
                <div class="mb-4 info-box bg-green-50 border-green-200">
                    <div class="font-semibold text-green-800 mb-1">Theoretical Solution Required: <span id="theoreticalSolution" class="text-base sm:text-lg font-bold text-green-700">1000.00 ltr</span></div>
                    <div class="text-xs text-gray-600 mt-1">
                        <span class="font-semibold">Dosing Ratio 4:1 → </span>
                        <span>Dye: <span id="theoreticalDyeSol" class="font-bold text-green-700">800.00 ltr</span></span>
                        <span class="mx-1">|</span>
                        <span>Alkali: <span id="theoreticalAlkaliSol" class="font-bold text-green-700">200.00 ltr</span></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="input-label">Dye Solution to Prepare (ltr)</label>
                        <input type="number" id="dyeSolution" value="840" oninput="this.dataset.userModified='true'; calculate();" class="input-field">
                        <div id="dyeDifference" class="mt-2 info-box bg-blue-50 border-blue-200">
                            <span class="font-semibold text-blue-800">vs Theoretical: </span>
                            <span class="text-sm font-bold text-blue-700">+40.00 ltr</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="input-label">Alkali Solution to Prepare (ltr)</label>
                        <input type="number" id="alkaliSolution" value="210" oninput="this.dataset.userModified='true'; calculate();" class="input-field">
                        <div id="alkaliDifference" class="mt-2 info-box bg-green-50 border-green-200">
                            <span class="font-semibold text-green-800">vs Theoretical: </span>
                            <span class="text-sm font-bold text-green-700">+10.00 ltr</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dye Solution Recipe -->
            <div class="section-card mb-5 sm:mb-6">
                <h2 class="section-header">
                    <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
                    Dye Solution Recipe
                </h2>
                <div class="mb-3 info-box bg-blue-50 border-blue-200 font-semibold">
                    Prepare in Dye Solution: <span id="dyeSolutionLabel" class="text-blue-700">840.00</span> ltr
                </div>
                <div class="overflow-x-auto -mx-3 sm:mx-0">
                    <table class="w-full border-collapse min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left" style="width: 40%;">Item</th>
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left bg-amber-50" style="width: 30%;">Recipe (g/l)</th>
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left bg-emerald-50" style="width: 30%;">Bulk (g)</th>
                            </tr>
                        </thead>
                        <tbody id="dyeTableBody">
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" value="Yellow" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" oninput="calculate()" class="dye-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right dye-quantity">0.00</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" value="Red" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" oninput="calculate()" class="dye-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right dye-quantity">0.00</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" value="Blue" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" oninput="calculate()" class="dye-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right dye-quantity">0.00</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" placeholder="Dye" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" oninput="calculate()" class="dye-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right dye-quantity">0.00</td>
                            </tr>
                            <tr class="table-header font-bold bg-gray-100">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2.5"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2.5 bg-amber-100" style="white-space: nowrap;"><span style="font-size: 0.875rem;">Total:</span> <span id="totalDyeConc" class="number-display">0.00</span> <span style="font-size: 0.875rem;">g/l</span></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2.5 bg-emerald-100"></td>
                            </tr>
                            <tr class="table-header bg-blue-50">
                                <td colspan="3" class="border border-gray-200 px-3 sm:px-4 py-2.5 font-semibold text-gray-700">Auxiliaries</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" value="Wetting agent" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" step="0.1" oninput="calculate()" class="aux-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right aux-quantity">0.00</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" value="Anti foaming" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" step="0.1" oninput="calculate()" class="aux-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right aux-quantity">0.00</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-200 px-3 sm:px-4 py-2"><input type="text" placeholder="Auxiliary" class="w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50"><input type="number" placeholder="0" step="0.1" oninput="calculate()" class="aux-recipe w-full px-2 py-1.5 text-sm font-medium border border-gray-300 rounded focus:border-blue-500 focus:outline-none"></td>
                                <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold number-display text-right aux-quantity">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alkali System -->
            <div class="section-card mb-5 sm:mb-6">
                <h2 class="section-header">
                    <span class="w-1 h-5 bg-indigo-500 rounded-full"></span>
                    Alkali System
                </h2>
                
                <!-- Alkali Method Selection -->
                <div class="mb-4">
                    <label class="input-label">Alkali Method</label>
                    <select id="alkaliMethod" onchange="updateAlkaliMethod()" class="input-field cursor-pointer">
                        <option value="silicate-free">A. Silicate-Free Method</option>
                        <option value="sodium-silicate">B. Sodium Silicate Method</option>
                        <option value="modified-silicate">C. Modified Sodium Silicate Method</option>
                        <option value="tropical-region">D. Silicate-Free Method (Tropical Region)</option>
                    </select>
                </div>
                
                <div class="mb-4 info-box bg-green-50 border-green-200 font-semibold">
                    Prepare in Alkali Solution: <span id="alkaliSolutionLabel" class="text-green-700">210.00</span> ltr
                </div>

                <!-- Method A: Silicate Free -->
                <div id="methodA">
                    <div class="mb-4">
                        <label class="input-label">NaOH Type</label>
                        <select id="alkaliTypeA" onchange="handleAlkaliTypeChange('A')" class="input-field">
                            <option value="38">NaOH 38°Bé (32.5% w/w)</option>
                            <option value="50">NaOH 50°Bé (50.1% w/w)</option>
                            <option value="flakes">NaOH Flakes (100% w/w)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div id="customInputA" class="hidden mb-4">
                        <div class="mb-2">
                            <label class="input-label">Baumé (°Bé)</label>
                            <input type="number" id="customBaumeA" min="1" max="50" placeholder="38" oninput="updateCustomNaOH('A')" class="input-field">
                        </div>
                        <div id="customInfoA" class="info-box bg-gray-50 border-gray-300">
                            <div class="grid grid-cols-3 gap-2">
                                <div><span class="text-gray-600">ρ:</span> <span id="customRhoA" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">g/l:</span> <span id="customGlA" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">%:</span> <span id="customPercentA" class="font-bold">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 info-box bg-blue-50 border-blue-300">
                        <p class="font-semibold">Based on Dye: <span id="dyeConcA" class="text-blue-600">0.00</span> g/l</p>
                    </div>
                </div>

                <!-- Method B: Sodium Silicate -->
                <div id="methodB" class="hidden">
                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <div>
                            <label class="input-label">Sodium Silicate Concentration</label>
                            <select id="silicateConc" onchange="calculate()" class="input-field">
                                <option value="37-40">37-40°Bé (130 g/l)</option>
                                <option value="40-42">40-42°Bé (110 g/l)</option>
                                <option value="48-50" selected>48-50°Bé (100 g/l)</option>
                                <option value="58-60">58-60°Bé (90 g/l)</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label">NaOH Concentration</label>
                            <select id="naohConcB" onchange="handleAlkaliTypeChange('B')" class="input-field">
                                <option value="38" selected>38°Bé (32.5% w/w)</option>
                                <option value="50">50°Bé (50.1% w/w)</option>
                                <option value="flakes">Flakes (100% w/w)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="customInputB" class="hidden mb-4">
                        <div class="mb-2">
                            <label class="input-label">Baumé (°Bé)</label>
                            <input type="number" id="customBaumeB" min="1" max="50" placeholder="38" oninput="updateCustomNaOH('B')" class="input-field">
                        </div>
                        <div id="customInfoB" class="info-box bg-gray-50 border-gray-300">
                            <div class="grid grid-cols-3 gap-2">
                                <div><span class="text-gray-600">ρ:</span> <span id="customRhoB" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">g/l:</span> <span id="customGlB" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">%:</span> <span id="customPercentB" class="font-bold">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 info-box bg-green-50 border-green-300">
                        <p class="font-semibold">Based on Dye: <span id="dyeConcB" class="text-blue-600">0.00</span> g/l</p>
                    </div>
                </div>

                <!-- Method C: Modified Sodium Silicate -->
                <div id="methodC" class="hidden">
                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <div>
                            <label class="input-label">Sodium Silicate Concentration</label>
                            <select id="silicateConcC" onchange="calculate()" class="input-field">
                                <option value="37-40">37-40°Bé (65 g/l)</option>
                                <option value="40-42">40-42°Bé (55 g/l)</option>
                                <option value="48-50" selected>48-50°Bé (50 g/l)</option>
                                <option value="58-60">58-60°Bé (45 g/l)</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label">NaOH Concentration</label>
                            <select id="naohConcC" onchange="handleAlkaliTypeChange('C')" class="input-field">
                                <option value="38" selected>38°Bé (32.5% w/w)</option>
                                <option value="50">50°Bé (50.1% w/w)</option>
                                <option value="flakes">Flakes (100% w/w)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="customInputC" class="hidden mb-4">
                        <div class="mb-2">
                            <label class="input-label">Baumé (°Bé)</label>
                            <input type="number" id="customBaumeC" min="1" max="50" placeholder="38" oninput="updateCustomNaOH('C')" class="input-field">
                        </div>
                        <div id="customInfoC" class="info-box bg-gray-50 border-gray-300">
                            <div class="grid grid-cols-3 gap-2">
                                <div><span class="text-gray-600">ρ:</span> <span id="customRhoC" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">g/l:</span> <span id="customGlC" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">%:</span> <span id="customPercentC" class="font-bold">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 info-box bg-purple-50 border-purple-300">
                        <p class="font-semibold">Based on Dye: <span id="dyeConcC" class="text-blue-600">0.00</span> g/l</p>
                    </div>
                </div>

                <!-- Method D: Tropical Region -->
                <div id="methodD" class="hidden">
                    <div class="mb-4">
                        <label class="input-label">NaOH Concentration</label>
                        <select id="naohConcD" onchange="handleAlkaliTypeChange('D')" class="input-field">
                            <option value="50" selected>50°Bé (50.1% w/w)</option>
                            <option value="38">38°Bé (32.5% w/w)</option>
                            <option value="flakes">Flakes (100% w/w)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div id="customInputD" class="hidden mb-4">
                        <div class="mb-2">
                            <label class="input-label">Baumé (°Bé)</label>
                            <input type="number" id="customBaumeD" min="1" max="50" placeholder="50" oninput="updateCustomNaOH('D')" class="input-field">
                        </div>
                        <div id="customInfoD" class="info-box bg-gray-50 border-gray-300">
                            <div class="grid grid-cols-3 gap-2">
                                <div><span class="text-gray-600">ρ:</span> <span id="customRhoD" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">g/l:</span> <span id="customGlD" class="font-bold">-</span></div>
                                <div><span class="text-gray-600">%:</span> <span id="customPercentD" class="font-bold">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 info-box bg-orange-50 border-orange-300">
                        <p class="font-semibold">Based on Dye: <span id="dyeConcD" class="text-blue-600">0.00</span> g/l</p>
                    </div>
                </div>

                <!-- Alkali Table -->
                <div class="overflow-x-auto -mx-3 sm:mx-0">
                    <table class="w-full border-collapse min-w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left" style="width: 40%;">Alkali</th>
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left bg-amber-50" style="width: 30%;">Recipe</th>
                                <th class="border border-gray-200 px-3 sm:px-4 py-2.5 text-left bg-emerald-50" style="width: 30%;">Bulk (g)</th>
                            </tr>
                        </thead>
                        <tbody id="alkaliTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NaOH Reference Table -->
            <div class="section-card mt-5 sm:mt-6">
                <button onclick="toggleTable()" class="w-full flex items-center justify-between text-left hover:opacity-80 transition-opacity">
                    <h2 class="section-header mb-0">
                        <span class="w-1 h-5 bg-gray-500 rounded-full"></span>
                        NaOH Concentration Reference Table
                    </h2>
                    <svg id="tableIcon" class="w-6 h-6 transform transition-transform text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div id="naohTable" class="hidden mt-3 overflow-x-auto">
                    <table class="w-full border-collapse text-xs sm:text-sm">
                        <thead>
                            <tr class="table-header">
                                <th class="border px-2 py-1">Baumé (°Bé)</th>
                                <th class="border px-2 py-1">Specific Weight (ρ)</th>
                                <th class="border px-2 py-1">NaOH Content (g/l)</th>
                                <th class="border px-2 py-1">NaOH % (w/w)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="border px-2 py-1 text-center">1</td><td class="border px-2 py-1 text-center">1.007</td><td class="border px-2 py-1 text-center">6.0</td><td class="border px-2 py-1 text-center">0.59</td></tr>
                            <tr><td class="border px-2 py-1 text-center">2</td><td class="border px-2 py-1 text-center">1.014</td><td class="border px-2 py-1 text-center">12.0</td><td class="border px-2 py-1 text-center">1.18</td></tr>
                            <tr><td class="border px-2 py-1 text-center">3</td><td class="border px-2 py-1 text-center">1.022</td><td class="border px-2 py-1 text-center">18.9</td><td class="border px-2 py-1 text-center">1.85</td></tr>
                            <tr><td class="border px-2 py-1 text-center">4</td><td class="border px-2 py-1 text-center">1.029</td><td class="border px-2 py-1 text-center">25.7</td><td class="border px-2 py-1 text-center">2.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">5</td><td class="border px-2 py-1 text-center">1.036</td><td class="border px-2 py-1 text-center">32.6</td><td class="border px-2 py-1 text-center">3.15</td></tr>
                            <tr><td class="border px-2 py-1 text-center">6</td><td class="border px-2 py-1 text-center">1.045</td><td class="border px-2 py-1 text-center">39.6</td><td class="border px-2 py-1 text-center">3.79</td></tr>
                            <tr><td class="border px-2 py-1 text-center">7</td><td class="border px-2 py-1 text-center">1.052</td><td class="border px-2 py-1 text-center">47.3</td><td class="border px-2 py-1 text-center">4.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">8</td><td class="border px-2 py-1 text-center">1.060</td><td class="border px-2 py-1 text-center">55.0</td><td class="border px-2 py-1 text-center">5.20</td></tr>
                            <tr><td class="border px-2 py-1 text-center">9</td><td class="border px-2 py-1 text-center">1.067</td><td class="border px-2 py-1 text-center">62.5</td><td class="border px-2 py-1 text-center">5.86</td></tr>
                            <tr><td class="border px-2 py-1 text-center">10</td><td class="border px-2 py-1 text-center">1.075</td><td class="border px-2 py-1 text-center">70.7</td><td class="border px-2 py-1 text-center">6.58</td></tr>
                            <tr><td class="border px-2 py-1 text-center">11</td><td class="border px-2 py-1 text-center">1.083</td><td class="border px-2 py-1 text-center">79.1</td><td class="border px-2 py-1 text-center">7.30</td></tr>
                            <tr><td class="border px-2 py-1 text-center">12</td><td class="border px-2 py-1 text-center">1.091</td><td class="border px-2 py-1 text-center">88.0</td><td class="border px-2 py-1 text-center">8.07</td></tr>
                            <tr><td class="border px-2 py-1 text-center">13</td><td class="border px-2 py-1 text-center">1.100</td><td class="border px-2 py-1 text-center">96.6</td><td class="border px-2 py-1 text-center">8.78</td></tr>
                            <tr><td class="border px-2 py-1 text-center">14</td><td class="border px-2 py-1 text-center">1.108</td><td class="border px-2 py-1 text-center">105.3</td><td class="border px-2 py-1 text-center">9.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">15</td><td class="border px-2 py-1 text-center">1.116</td><td class="border px-2 py-1 text-center">114.9</td><td class="border px-2 py-1 text-center">10.30</td></tr>
                            <tr><td class="border px-2 py-1 text-center">16</td><td class="border px-2 py-1 text-center">1.125</td><td class="border px-2 py-1 text-center">124.4</td><td class="border px-2 py-1 text-center">11.06</td></tr>
                            <tr><td class="border px-2 py-1 text-center">17</td><td class="border px-2 py-1 text-center">1.134</td><td class="border px-2 py-1 text-center">134.0</td><td class="border px-2 py-1 text-center">11.84</td></tr>
                            <tr><td class="border px-2 py-1 text-center">18</td><td class="border px-2 py-1 text-center">1.142</td><td class="border px-2 py-1 text-center">145.0</td><td class="border px-2 py-1 text-center">12.60</td></tr>
                            <tr><td class="border px-2 py-1 text-center">19</td><td class="border px-2 py-1 text-center">1.152</td><td class="border px-2 py-1 text-center">155.5</td><td class="border px-2 py-1 text-center">13.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">20</td><td class="border px-2 py-1 text-center">1.161</td><td class="border px-2 py-1 text-center">166.7</td><td class="border px-2 py-1 text-center">14.35</td></tr>
                            <tr><td class="border px-2 py-1 text-center">21</td><td class="border px-2 py-1 text-center">1.171</td><td class="border px-2 py-1 text-center">177.4</td><td class="border px-2 py-1 text-center">15.15</td></tr>
                            <tr><td class="border px-2 py-1 text-center">22</td><td class="border px-2 py-1 text-center">1.180</td><td class="border px-2 py-1 text-center">188.8</td><td class="border px-2 py-1 text-center">16.00</td></tr>
                            <tr><td class="border px-2 py-1 text-center">23</td><td class="border px-2 py-1 text-center">1.190</td><td class="border px-2 py-1 text-center">201.2</td><td class="border px-2 py-1 text-center">16.91</td></tr>
                            <tr><td class="border px-2 py-1 text-center">24</td><td class="border px-2 py-1 text-center">1.200</td><td class="border px-2 py-1 text-center">213.7</td><td class="border px-2 py-1 text-center">17.81</td></tr>
                            <tr><td class="border px-2 py-1 text-center">25</td><td class="border px-2 py-1 text-center">1.210</td><td class="border px-2 py-1 text-center">226.4</td><td class="border px-2 py-1 text-center">18.71</td></tr>
                            <tr><td class="border px-2 py-1 text-center">26</td><td class="border px-2 py-1 text-center">1.220</td><td class="border px-2 py-1 text-center">239.7</td><td class="border px-2 py-1 text-center">19.65</td></tr>
                            <tr><td class="border px-2 py-1 text-center">27</td><td class="border px-2 py-1 text-center">1.231</td><td class="border px-2 py-1 text-center">253.6</td><td class="border px-2 py-1 text-center">20.60</td></tr>
                            <tr><td class="border px-2 py-1 text-center">28</td><td class="border px-2 py-1 text-center">1.241</td><td class="border px-2 py-1 text-center">267.4</td><td class="border px-2 py-1 text-center">21.55</td></tr>
                            <tr><td class="border px-2 py-1 text-center">29</td><td class="border px-2 py-1 text-center">1.252</td><td class="border px-2 py-1 text-center">281.7</td><td class="border px-2 py-1 text-center">22.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">30</td><td class="border px-2 py-1 text-center">1.263</td><td class="border px-2 py-1 text-center">296.8</td><td class="border px-2 py-1 text-center">23.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">31</td><td class="border px-2 py-1 text-center">1.274</td><td class="border px-2 py-1 text-center">311.9</td><td class="border px-2 py-1 text-center">24.48</td></tr>
                            <tr><td class="border px-2 py-1 text-center">32</td><td class="border px-2 py-1 text-center">1.285</td><td class="border px-2 py-1 text-center">327.7</td><td class="border px-2 py-1 text-center">25.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">33</td><td class="border px-2 py-1 text-center">1.297</td><td class="border px-2 py-1 text-center">344.7</td><td class="border px-2 py-1 text-center">26.58</td></tr>
                            <tr><td class="border px-2 py-1 text-center">34</td><td class="border px-2 py-1 text-center">1.308</td><td class="border px-2 py-1 text-center">361.7</td><td class="border px-2 py-1 text-center">27.65</td></tr>
                            <tr><td class="border px-2 py-1 text-center">35</td><td class="border px-2 py-1 text-center">1.320</td><td class="border px-2 py-1 text-center">380.6</td><td class="border px-2 py-1 text-center">28.83</td></tr>
                            <tr><td class="border px-2 py-1 text-center">36</td><td class="border px-2 py-1 text-center">1.332</td><td class="border px-2 py-1 text-center">399.6</td><td class="border px-2 py-1 text-center">30.00</td></tr>
                            <tr><td class="border px-2 py-1 text-center">37</td><td class="border px-2 py-1 text-center">1.345</td><td class="border px-2 py-1 text-center">419.6</td><td class="border px-2 py-1 text-center">31.20</td></tr>
                            <tr class="bg-yellow-50"><td class="border px-2 py-1 text-center font-bold">38</td><td class="border px-2 py-1 text-center font-bold">1.357</td><td class="border px-2 py-1 text-center font-bold">441.0</td><td class="border px-2 py-1 text-center font-bold">32.50</td></tr>
                            <tr><td class="border px-2 py-1 text-center">39</td><td class="border px-2 py-1 text-center">1.370</td><td class="border px-2 py-1 text-center">462.1</td><td class="border px-2 py-1 text-center">33.73</td></tr>
                            <tr><td class="border px-2 py-1 text-center">40</td><td class="border px-2 py-1 text-center">1.383</td><td class="border px-2 py-1 text-center">484.1</td><td class="border px-2 py-1 text-center">35.00</td></tr>
                            <tr><td class="border px-2 py-1 text-center">41</td><td class="border px-2 py-1 text-center">1.397</td><td class="border px-2 py-1 text-center">507.9</td><td class="border px-2 py-1 text-center">36.36</td></tr>
                            <tr><td class="border px-2 py-1 text-center">42</td><td class="border px-2 py-1 text-center">1.410</td><td class="border px-2 py-1 text-center">530.9</td><td class="border px-2 py-1 text-center">37.65</td></tr>
                            <tr><td class="border px-2 py-1 text-center">43</td><td class="border px-2 py-1 text-center">1.424</td><td class="border px-2 py-1 text-center">556.2</td><td class="border px-2 py-1 text-center">39.06</td></tr>
                            <tr><td class="border px-2 py-1 text-center">44</td><td class="border px-2 py-1 text-center">1.438</td><td class="border px-2 py-1 text-center">582.0</td><td class="border px-2 py-1 text-center">40.47</td></tr>
                            <tr><td class="border px-2 py-1 text-center">45</td><td class="border px-2 py-1 text-center">1.453</td><td class="border px-2 py-1 text-center">610.6</td><td class="border px-2 py-1 text-center">42.02</td></tr>
                            <tr><td class="border px-2 py-1 text-center">46</td><td class="border px-2 py-1 text-center">1.468</td><td class="border px-2 py-1 text-center">639.8</td><td class="border px-2 py-1 text-center">43.58</td></tr>
                            <tr><td class="border px-2 py-1 text-center">47</td><td class="border px-2 py-1 text-center">1.483</td><td class="border px-2 py-1 text-center">669.7</td><td class="border px-2 py-1 text-center">45.16</td></tr>
                            <tr><td class="border px-2 py-1 text-center">48</td><td class="border px-2 py-1 text-center">1.498</td><td class="border px-2 py-1 text-center">700.0</td><td class="border px-2 py-1 text-center">46.73</td></tr>
                            <tr><td class="border px-2 py-1 text-center">49</td><td class="border px-2 py-1 text-center">1.514</td><td class="border px-2 py-1 text-center">732.9</td><td class="border px-2 py-1 text-center">48.41</td></tr>
                            <tr class="bg-yellow-50"><td class="border px-2 py-1 text-center font-bold">50</td><td class="border px-2 py-1 text-center font-bold">1.530</td><td class="border px-2 py-1 text-center font-bold">766.5</td><td class="border px-2 py-1 text-center font-bold">50.10</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Complete Work Order Summary -->
            <div id="workOrderSection" class="section-card mt-5 sm:mt-6 p-6 bg-white rounded-xl border-2 border-green-500" style="max-width: 210mm;">
                <div class="flex items-center justify-between mb-4 print:mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-green-500 rounded-full print:hidden"></span>
                        CPB Dye Solution Work Order
                    </h2>
                    <button onclick="copyWorkOrderAsImage()" class="px-3 sm:px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 print:hidden">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        <span class="hidden sm:inline">Download</span>
                        <span class="sm:hidden">Download</span>
                    </button>
                </div>

                <!-- Work Order Header -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-300">
                    <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                        <div class="flex">
                            <span class="text-gray-600 w-24">Date:</span>
                            <span id="woDate" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Order No.:</span>
                            <span id="woOrderNo" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Customer:</span>
                            <span id="woCustomer" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Color:</span>
                            <span id="woColor" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Fabric Type:</span>
                            <span id="woFabricType" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Fabric Qty.:</span>
                            <span id="woFabric" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Pick-up:</span>
                            <span id="woPickup" class="font-semibold">-</span>
                        </div>
                        <div class="flex">
                            <span class="text-gray-600 w-24">Method:</span>
                            <span id="woMethod" class="font-semibold">-</span>
                        </div>
                    </div>
                </div>

                <!-- Solution Summary -->
                <div class="mb-4 grid grid-cols-3 gap-3">
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center">
                        <div class="text-xs text-gray-600 mb-1">Required Sol.</div>
                        <div id="woTotalSol" class="text-lg font-bold text-blue-600">-</div>
                        <div id="woTheoreticalNote" class="text-xs text-gray-500 mt-1">-</div>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200 text-center">
                        <div class="text-xs text-gray-600 mb-1">Actual Dye Sol.</div>
                        <div id="woDyeSol" class="text-lg font-bold text-indigo-600">-</div>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg border border-green-200 text-center">
                        <div class="text-xs text-gray-600 mb-1">Actual Alkali Sol.</div>
                        <div id="woAlkaliSol" class="text-lg font-bold text-green-600">-</div>
                    </div>
                </div>

                <!-- Dye Recipe Table -->
                <div class="mb-4">
                    <h3 class="font-bold text-base mb-2 text-gray-700">Dye Solution Recipe</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-blue-100">
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 40%;">Item</th>
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 30%;">Recipe (g/l)</th>
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 30%;">Quantity (g)</th>
                                </tr>
                            </thead>
                            <tbody id="woDyeTable">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Alkali Recipe Table -->
                <div>
                    <h3 class="font-bold text-base mb-2 text-gray-700">Alkali Solution Recipe</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-green-100">
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 40%;">Item</th>
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 30%;">Recipe</th>
                                    <th class="border border-gray-300 px-2 sm:px-3 py-2 text-left" style="width: 30%;">Quantity (g)</th>
                                </tr>
                            </thead>
                            <tbody id="woAlkaliTable">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Save Recipe Section -->
            <div class="section-card mt-5 sm:mt-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300">
                <div class="flex items-center gap-3 mb-3">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    <h2 class="text-base sm:text-lg font-bold text-gray-800">Save Current Recipe</h2>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="recipeName" placeholder="Enter recipe name (e.g., Red-Cotton-CustomerA)" class="flex-1 input-field bg-white">
                    <button onclick="saveRecipe()" class="px-6 py-2.5 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Recipe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load html2canvas from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Recipe Management Functions
        function saveRecipe() {
            const recipeName = document.getElementById('recipeName').value.trim();
            if (!recipeName) {
                alert('Please enter a recipe name');
                return;
            }
            
            const recipeData = {
                // Order Information
                customerName: document.getElementById('customerName').value,
                colorName: document.getElementById('colorName').value,
                fabricType: document.getElementById('fabricType').value,
                orderNo: document.getElementById('orderNo').value,
                
                // Fabric Information
                fabricMode: document.querySelector('input[name="fabricMode"]:checked').value,
                fabricQuantity: document.getElementById('fabricQuantity').value,
                fabricWeight: document.getElementById('fabricWeight').value,
                fabricLength: document.getElementById('fabricLength').value,
                pickUp: document.getElementById('pickUp').value,
                
                // Solution Preparation
                dyeSolution: document.getElementById('dyeSolution').value,
                alkaliSolution: document.getElementById('alkaliSolution').value,
                
                // Dye Recipe
                dyeRecipes: Array.from(document.querySelectorAll('.dye-recipe')).map((input, i) => ({
                    name: document.querySelectorAll('#dyeTableBody tr:not(.bg-gray-100):not(.bg-blue-50) input[type="text"]')[i]?.value || '',
                    value: input.value
                })),
                
                // Auxiliary Recipe
                auxRecipes: Array.from(document.querySelectorAll('.aux-recipe')).map((input, i) => ({
                    name: document.querySelectorAll('#dyeTableBody tr.bg-blue-50 ~ tr input[type="text"]')[i]?.value || '',
                    value: input.value
                })),
                
                // Alkali System
                alkaliMethod: document.getElementById('alkaliMethod').value,
                alkaliTypeA: document.getElementById('alkaliTypeA').value,
                customBaumeA: document.getElementById('customBaumeA').value,
                silicateConc: document.getElementById('silicateConc').value,
                naohConcB: document.getElementById('naohConcB').value,
                customBaumeB: document.getElementById('customBaumeB').value,
                silicateConcC: document.getElementById('silicateConcC').value,
                naohConcC: document.getElementById('naohConcC').value,
                customBaumeC: document.getElementById('customBaumeC').value,
                naohConcD: document.getElementById('naohConcD').value,
                customBaumeD: document.getElementById('customBaumeD').value
            };
            
            // Get existing recipes
            let recipes = JSON.parse(localStorage.getItem('cpbRecipes') || '{}');
            recipes[recipeName] = recipeData;
            localStorage.setItem('cpbRecipes', JSON.stringify(recipes));
            
            // Update dropdown
            updateRecipeList();
            document.getElementById('savedRecipes').value = recipeName;
            
            alert('Recipe saved successfully!');
        }
        
        function loadRecipe() {
            const recipeName = document.getElementById('savedRecipes').value;
            if (!recipeName) return;
            
            const recipes = JSON.parse(localStorage.getItem('cpbRecipes') || '{}');
            const recipeData = recipes[recipeName];
            
            if (!recipeData) {
                alert('Recipe not found');
                return;
            }
            
            // Load Order Information
            document.getElementById('customerName').value = recipeData.customerName || '';
            document.getElementById('colorName').value = recipeData.colorName || '';
            document.getElementById('fabricType').value = recipeData.fabricType || '';
            document.getElementById('orderNo').value = recipeData.orderNo || '';
            
            // Load Fabric Information
            document.querySelector(`input[name="fabricMode"][value="${recipeData.fabricMode}"]`).checked = true;
            updateFabricMode();
            document.getElementById('fabricQuantity').value = recipeData.fabricQuantity || '';
            document.getElementById('fabricWeight').value = recipeData.fabricWeight || '';
            document.getElementById('fabricLength').value = recipeData.fabricLength || '';
            document.getElementById('pickUp').value = recipeData.pickUp || '';
            
            // Load Solution Preparation
            document.getElementById('dyeSolution').value = recipeData.dyeSolution || '';
            document.getElementById('dyeSolution').dataset.userModified = 'true';
            document.getElementById('alkaliSolution').value = recipeData.alkaliSolution || '';
            document.getElementById('alkaliSolution').dataset.userModified = 'true';
            
            // Load Dye Recipe
            const dyeRecipeInputs = document.querySelectorAll('.dye-recipe');
            const dyeNameInputs = document.querySelectorAll('#dyeTableBody tr:not(.bg-gray-100):not(.bg-blue-50) input[type="text"]');
            recipeData.dyeRecipes.forEach((item, i) => {
                if (dyeNameInputs[i]) dyeNameInputs[i].value = item.name;
                if (dyeRecipeInputs[i]) dyeRecipeInputs[i].value = item.value;
            });
            
            // Load Auxiliary Recipe
            const auxRecipeInputs = document.querySelectorAll('.aux-recipe');
            const auxNameInputs = document.querySelectorAll('#dyeTableBody tr.bg-blue-50 ~ tr input[type="text"]');
            recipeData.auxRecipes.forEach((item, i) => {
                if (auxNameInputs[i]) auxNameInputs[i].value = item.name;
                if (auxRecipeInputs[i]) auxRecipeInputs[i].value = item.value;
            });
            
            // Load Alkali System
            document.getElementById('alkaliMethod').value = recipeData.alkaliMethod || 'silicate-free';
            updateAlkaliMethod();
            document.getElementById('alkaliTypeA').value = recipeData.alkaliTypeA || '38';
            document.getElementById('customBaumeA').value = recipeData.customBaumeA || '';
            document.getElementById('silicateConc').value = recipeData.silicateConc || '48-50';
            document.getElementById('naohConcB').value = recipeData.naohConcB || '38';
            document.getElementById('customBaumeB').value = recipeData.customBaumeB || '';
            document.getElementById('silicateConcC').value = recipeData.silicateConcC || '48-50';
            document.getElementById('naohConcC').value = recipeData.naohConcC || '38';
            document.getElementById('customBaumeC').value = recipeData.customBaumeC || '';
            document.getElementById('naohConcD').value = recipeData.naohConcD || '50';
            document.getElementById('customBaumeD').value = recipeData.customBaumeD || '';
            
            handleAlkaliTypeChange('A');
            handleAlkaliTypeChange('B');
            handleAlkaliTypeChange('C');
            handleAlkaliTypeChange('D');
            
            // Recalculate
            calculate();
            updateWorkOrder();
            
            alert('Recipe loaded successfully!');
        }
        
        function deleteRecipe() {
            const recipeName = document.getElementById('savedRecipes').value;
            if (!recipeName) {
                alert('Please select a recipe to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${recipeName}"?`)) {
                return;
            }
            
            let recipes = JSON.parse(localStorage.getItem('cpbRecipes') || '{}');
            delete recipes[recipeName];
            localStorage.setItem('cpbRecipes', JSON.stringify(recipes));
            
            updateRecipeList();
            alert('Recipe deleted successfully!');
        }
        
        function updateRecipeList() {
            const recipes = JSON.parse(localStorage.getItem('cpbRecipes') || '{}');
            const select = document.getElementById('savedRecipes');
            
            // Clear existing options except first
            select.innerHTML = '<option value="">-- Select a recipe --</option>';
            
            // Add recipe options
            Object.keys(recipes).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Format number: show 1 decimal if .0, otherwise 2 decimals
        function formatNumber(num) {
            const rounded = Math.round(num * 100) / 100;
            if (rounded % 1 === 0) {
                return rounded.toFixed(1);
            }
            return rounded.toFixed(2);
        }
        
        // NaOH Baumé lookup table (from official reference)
        const baumeTable = {
            1: { rho: 1.007, gl: 6.0, percent: 0.59 },
            2: { rho: 1.014, gl: 12.0, percent: 1.18 },
            3: { rho: 1.022, gl: 18.9, percent: 1.85 },
            4: { rho: 1.029, gl: 25.7, percent: 2.50 },
            5: { rho: 1.036, gl: 32.6, percent: 3.15 },
            6: { rho: 1.045, gl: 39.6, percent: 3.79 },
            7: { rho: 1.052, gl: 47.3, percent: 4.50 },
            8: { rho: 1.060, gl: 55.0, percent: 5.20 },
            9: { rho: 1.067, gl: 62.5, percent: 5.86 },
            10: { rho: 1.075, gl: 70.7, percent: 6.58 },
            11: { rho: 1.083, gl: 79.1, percent: 7.30 },
            12: { rho: 1.091, gl: 88.0, percent: 8.07 },
            13: { rho: 1.100, gl: 96.6, percent: 8.78 },
            14: { rho: 1.108, gl: 105.3, percent: 9.50 },
            15: { rho: 1.116, gl: 114.9, percent: 10.30 },
            16: { rho: 1.125, gl: 124.4, percent: 11.06 },
            17: { rho: 1.134, gl: 134.0, percent: 11.84 },
            18: { rho: 1.142, gl: 145.0, percent: 12.60 },
            19: { rho: 1.152, gl: 155.5, percent: 13.50 },
            20: { rho: 1.161, gl: 166.7, percent: 14.35 },
            21: { rho: 1.171, gl: 177.4, percent: 15.15 },
            22: { rho: 1.180, gl: 188.8, percent: 16.00 },
            23: { rho: 1.190, gl: 201.2, percent: 16.91 },
            24: { rho: 1.200, gl: 213.7, percent: 17.81 },
            25: { rho: 1.210, gl: 226.4, percent: 18.71 },
            26: { rho: 1.220, gl: 239.7, percent: 19.65 },
            27: { rho: 1.231, gl: 253.6, percent: 20.60 },
            28: { rho: 1.241, gl: 267.4, percent: 21.55 },
            29: { rho: 1.252, gl: 281.7, percent: 22.50 },
            30: { rho: 1.263, gl: 296.8, percent: 23.50 },
            31: { rho: 1.274, gl: 311.9, percent: 24.48 },
            32: { rho: 1.285, gl: 327.7, percent: 25.50 },
            33: { rho: 1.297, gl: 344.7, percent: 26.58 },
            34: { rho: 1.308, gl: 361.7, percent: 27.65 },
            35: { rho: 1.320, gl: 380.6, percent: 28.83 },
            36: { rho: 1.332, gl: 399.6, percent: 30.00 },
            37: { rho: 1.345, gl: 419.6, percent: 31.20 },
            38: { rho: 1.357, gl: 441.0, percent: 32.50 },
            39: { rho: 1.370, gl: 462.1, percent: 33.73 },
            40: { rho: 1.383, gl: 484.1, percent: 35.00 },
            41: { rho: 1.397, gl: 507.9, percent: 36.36 },
            42: { rho: 1.410, gl: 530.9, percent: 37.65 },
            43: { rho: 1.424, gl: 556.2, percent: 39.06 },
            44: { rho: 1.438, gl: 582.0, percent: 40.47 },
            45: { rho: 1.453, gl: 610.6, percent: 42.02 },
            46: { rho: 1.468, gl: 639.8, percent: 43.58 },
            47: { rho: 1.483, gl: 669.7, percent: 45.16 },
            48: { rho: 1.498, gl: 700.0, percent: 46.73 },
            49: { rho: 1.514, gl: 732.9, percent: 48.41 },
            50: { rho: 1.530, gl: 766.5, percent: 50.10 }
        };

        function toggleTable() {
            const table = document.getElementById('naohTable');
            const icon = document.getElementById('tableIcon');
            table.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        async function copyWorkOrderAsImage() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-2">Processing...</span>';
            button.disabled = true;
            
            // Hide button before capturing
            const tempDisplay = button.style.display;
            button.style.display = 'none';
            
            try {
                const workOrder = document.getElementById('workOrderSection');
                
                // Use html2canvas to convert to image
                const canvas = await html2canvas(workOrder, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    windowWidth: 1200
                });
                
                // Show button again
                button.style.display = tempDisplay;
                button.innerHTML = originalText;
                button.disabled = false;
                
                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to generate image');
                        return;
                    }
                    
                    try {
                        // Always download (both desktop and mobile)
                        downloadImage(blob, button, originalText);
                        
                        // Reset button after 2 seconds
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('bg-green-600');
                            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            button.disabled = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to process image:', err);
                        button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span class="ml-2">Failed</span>';
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-red-600');
                        
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('bg-red-600');
                            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            button.disabled = false;
                        }, 2000);
                    }
                }, 'image/png');
                
            } catch (err) {
                console.error('Error generating image:', err);
                button.style.display = tempDisplay;
                button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span class="ml-2">Failed</span>';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-red-600');
                button.disabled = false;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-red-600');
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        }
        
        function downloadImage(blob, button, originalText) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date();
            const timestamp = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}_${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
            a.href = url;
            a.download = `CPB_WorkOrder_${timestamp}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show download success
            button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span class="ml-2">Downloaded!</span>';
            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            button.classList.add('bg-green-600');
        }

        function handleAlkaliTypeChange(method) {
            const typeSelect = document.getElementById(method === 'A' ? 'alkaliTypeA' : (method === 'B' ? 'naohConcB' : (method === 'C' ? 'naohConcC' : 'naohConcD')));
            const customInput = document.getElementById('customInput' + method);
            
            if (typeSelect.value === 'custom') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
            }
            calculate();
        }

        function updateCustomNaOH(method) {
            const baume = parseInt(document.getElementById('customBaume' + method).value);
            
            if (baume >= 1 && baume <= 50 && baumeTable[baume]) {
                const data = baumeTable[baume];
                document.getElementById('customRho' + method).textContent = data.rho;
                document.getElementById('customGl' + method).textContent = data.gl;
                document.getElementById('customPercent' + method).textContent = data.percent + '%';
            } else {
                document.getElementById('customRho' + method).textContent = '-';
                document.getElementById('customGl' + method).textContent = '-';
                document.getElementById('customPercent' + method).textContent = '-';
            }
            
            calculate();
        }

        function getNaOHData(method) {
            const typeSelect = document.getElementById(method === 'A' ? 'alkaliTypeA' : (method === 'B' ? 'naohConcB' : (method === 'C' ? 'naohConcC' : 'naohConcD')));
            const type = typeSelect.value;
            
            if (type === 'custom') {
                const baume = parseInt(document.getElementById('customBaume' + method).value);
                if (baume >= 1 && baume <= 50 && baumeTable[baume]) {
                    const data = baumeTable[baume];
                    return { specWeight: data.rho, contentGl: data.gl };
                } else {
                    return { specWeight: 1.357, contentGl: 441.0 };
                }
            } else {
                return naohConcData[type];
            }
        }

        
        // Tropical Region NaOH lookup table (based on 50% NaOH cc/l as standard)
        const tropicalRegionNaOH = {
            ranges: [
                { max: 10, cc: 2.5 },
                { min: 10, max: 20, cc: 3.0 },
                { min: 20, max: 40, cc: 4.5 },
                { min: 40, max: 60, cc: 6.5 },
                { min: 60, max: 80, cc: 8.5 },
                { min: 80, max: 100, cc: 10.5 },
                { min: 100, cc: 12.0 }
            ]
        };
        
        function getNaOHForTropicalRegion(dyeConc) {
            for (let range of tropicalRegionNaOH.ranges) {
                if (range.max && dyeConc <= range.max) {
                    return range.cc;
                } else if (!range.max && dyeConc >= range.min) {
                    return range.cc;
                }
            }
            return 2.5; // default
        }
        
        // Sodium Silicate data for Method B
        const sodiumSilicateDataB = {
            '37-40': { gl: 130, naoh: { 20: 23.5, 30: 28.5, 40: 28.5, 50: 33.5, 60: 33.5, 70: 38.5 } },
            '40-42': { gl: 110, naoh: { 20: 23.5, 30: 28.5, 40: 28.5, 50: 33.5, 60: 33.5, 70: 38.5 } },
            '48-50': { gl: 100, naoh: { 20: 15, 30: 20, 40: 20, 50: 25, 60: 25, 70: 30 } },
            '58-60': { gl: 90, naoh: { 20: 6, 30: 11, 40: 11, 50: 16, 60: 16, 70: 21 } }
        };

        // Sodium Silicate data for Method C
        const sodiumSilicateDataC = {
            '37-40': { gl: 65, naoh: { 10: 7, 20: 12, 30: 12, 40: 17, 50: 17, 60: 22 } },
            '40-42': { gl: 55, naoh: { 10: 7, 20: 12, 30: 12, 40: 17, 50: 17, 60: 22 } },
            '48-50': { gl: 50, naoh: { 10: 5, 20: 10, 30: 10, 40: 15, 50: 15, 60: 20 } },
            '58-60': { gl: 45, naoh: { 10: 3, 20: 7, 30: 7, 40: 11, 50: 11, 60: 16 } }
        };

        // NaOH concentration data
        const naohConcData = {
            '38': { specWeight: 1.357, contentGl: 441.0 },
            '50': { specWeight: 1.530, contentGl: 766.5 },
            'flakes': { specWeight: 1.0, contentGl: 1000.0 }
        };

        function getAlkaliRecommendationA(dyeConc) {
            // Formula: 38°Bé = 5 + (dyeConc / 5) ml/l
            const naoh38 = 5 + (dyeConc / 5);
            
            // Convert to other concentrations
            const naoh50 = (naoh38 * 441.0 / 766.5).toFixed(1);
            const naohFlakes = (naoh38 * 441.0 / 1000).toFixed(1);
            
            return { 
                naoh38: parseFloat(naoh38.toFixed(1)), 
                naoh50: parseFloat(naoh50), 
                naohFlakes: parseFloat(naohFlakes) 
            };
        }

        function getNaOHForSodiumSilicate(dyeConc, data) {
            const keys = Object.keys(data.naoh).map(Number).sort((a,b) => a-b);
            for (let i = 0; i < keys.length; i++) {
                if (dyeConc <= keys[i]) return data.naoh[keys[i]];
            }
            return data.naoh[keys[keys.length - 1]];
        }

        function updateFabricMode() {
            const mode = document.querySelector('input[name="fabricMode"]:checked').value;
            if (mode === 'direct') {
                document.getElementById('directMode').classList.remove('hidden');
                document.getElementById('calculateMode').classList.add('hidden');
            } else {
                document.getElementById('directMode').classList.add('hidden');
                document.getElementById('calculateMode').classList.remove('hidden');
            }
            calculate();
        }

        function updateAlkaliMethod() {
            const method = document.getElementById('alkaliMethod').value;
            document.getElementById('methodA').classList.toggle('hidden', method !== 'silicate-free');
            document.getElementById('methodB').classList.toggle('hidden', method !== 'sodium-silicate');
            document.getElementById('methodC').classList.toggle('hidden', method !== 'modified-silicate');
            document.getElementById('methodD').classList.toggle('hidden', method !== 'tropical-region');
            calculate();
        }

        function calculate() {
            // Fabric quantity
            const mode = document.querySelector('input[name="fabricMode"]:checked').value;
            let fabricQty;
            if (mode === 'direct') {
                fabricQty = parseFloat(document.getElementById('fabricQuantity').value) || 0;
            } else {
                const weight = parseFloat(document.getElementById('fabricWeight').value) || 0;
                const length = parseFloat(document.getElementById('fabricLength').value) || 0;
                fabricQty = weight * length / 1000;
                document.getElementById('calculatedFabric').textContent = formatNumber(fabricQty) + ' kg';
            }

            const pickUp = parseFloat(document.getElementById('pickUp').value) || 0;
            const theoretical = fabricQty * pickUp / 100;
            document.getElementById('theoreticalSolution').textContent = formatNumber(theoretical) + ' ltr';

            // Calculate theoretical 4:1 split
            const theoreticalDye = theoretical * 4 / 5;
            const theoreticalAlkali = theoretical * 1 / 5;
            
            // Display theoretical dye and alkali
            document.getElementById('theoreticalDyeSol').textContent = formatNumber(theoreticalDye) + ' ltr';
            document.getElementById('theoreticalAlkaliSol').textContent = formatNumber(theoreticalAlkali) + ' ltr';

            // Auto-update dye and alkali solutions based on theoretical values
            const dyeSolInput = document.getElementById('dyeSolution');
            const alkaliSolInput = document.getElementById('alkaliSolution');
            
            // Only auto-update if user hasn't manually changed the values
            if (!dyeSolInput.dataset.userModified) {
                dyeSolInput.value = (theoreticalDye + 40).toFixed(2);
            }
            if (!alkaliSolInput.dataset.userModified) {
                alkaliSolInput.value = (theoreticalAlkali + 10).toFixed(2);
            }

            const dyeSol = parseFloat(dyeSolInput.value) || 0;
            const alkaliSol = parseFloat(alkaliSolInput.value) || 0;
            
            // Show differences from theoretical
            const dyeDiff = dyeSol - theoreticalDye;
            const alkaliDiff = alkaliSol - theoreticalAlkali;
            
            document.getElementById('dyeDifference').innerHTML = `
                <span class="font-semibold text-blue-800">Diff. from Required: </span>
                <span class="text-sm font-bold ${dyeDiff >= 0 ? 'text-green-700' : 'text-red-700'}">${dyeDiff >= 0 ? '+' : ''}${formatNumber(dyeDiff)} ltr</span>
            `;
            
            document.getElementById('alkaliDifference').innerHTML = `
                <span class="font-semibold text-green-800">Diff. from Required: </span>
                <span class="text-sm font-bold ${alkaliDiff >= 0 ? 'text-green-700' : 'text-red-700'}">${alkaliDiff >= 0 ? '+' : ''}${formatNumber(alkaliDiff)} ltr</span>
            `;
            
            // Total actual solution (removed from display but keep calculation)
            const totalActual = dyeSol + alkaliSol;
            
            document.getElementById('dyeSolutionLabel').textContent = formatNumber(dyeSol);
            document.getElementById('alkaliSolutionLabel').textContent = formatNumber(alkaliSol);

            // Dyes - use mother liquor concentration (1.25x for dye solution)
            const dyeRecipes = document.querySelectorAll('.dye-recipe');
            const dyeQuantities = document.querySelectorAll('.dye-quantity');
            let totalDye = 0;
            dyeRecipes.forEach((input, i) => {
                const recipe = parseFloat(input.value) || 0;
                totalDye += recipe;
                // Mother liquor concentration for dye = recipe × 1.25
                const motherLiquorConc = recipe * 1.25;
                dyeQuantities[i].textContent = formatNumber(motherLiquorConc * dyeSol);
            });
            document.getElementById('totalDyeConc').textContent = formatNumber(totalDye);

            // Auxiliaries - use mother liquor concentration (1.25x for dye solution)
            const auxRecipes = document.querySelectorAll('.aux-recipe');
            const auxQuantities = document.querySelectorAll('.aux-quantity');
            auxRecipes.forEach((input, i) => {
                const recipe = parseFloat(input.value) || 0;
                // Mother liquor concentration for aux = recipe × 1.25
                const motherLiquorConc = recipe * 1.25;
                auxQuantities[i].textContent = formatNumber(motherLiquorConc * dyeSol);
            });

            // Alkali calculation based on method
            const method = document.getElementById('alkaliMethod').value;
            const tbody = document.getElementById('alkaliTableBody');
            tbody.innerHTML = '';

            if (method === 'silicate-free') {
                // Method A
                document.getElementById('dyeConcA').textContent = formatNumber(totalDye);
                const alkaliRec = getAlkaliRecommendationA(totalDye);

                const alkaliType = document.getElementById('alkaliTypeA').value;
                let naohMl, naohWeight;

                if (alkaliType === 'custom') {
                    const naohData = getNaOHData('A');
                    const customBaume = parseInt(document.getElementById('customBaumeA').value) || 38;
                    naohMl = (alkaliRec.naoh38 * 441.0 / naohData.contentGl).toFixed(1);
                    const specWeight = naohData.specWeight;
                    naohWeight = (naohMl * specWeight).toFixed(1);
                    
                    // Mother liquor concentration for alkali = × 5
                    const sodaAshMotherLiquor = 20 * 5;
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">NaOH ${customBaume}°Bé</div>
                                <div class="text-xs text-gray-500">ρ=${specWeight}</div>
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${naohMl} ml/l</div>
                                <div class="text-xs text-blue-600">= ${naohWeight} g/l</div>
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohMl) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                } else if (alkaliType === 'flakes') {
                    naohMl = alkaliRec.naohFlakes;
                    
                    // Mother liquor concentration for alkali = × 5
                    const sodaAshMotherLiquor = 20 * 5;
                    const naohMotherLiquor = naohMl * 5;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">NaOH Flakes</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${naohMl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(naohMotherLiquor * alkaliSol)}</td>
                        </tr>
                    `;
                } else {
                    naohMl = alkaliType === '38' ? alkaliRec.naoh38 : alkaliRec.naoh50;
                    const specWeight = alkaliType === '38' ? 1.357 : 1.530;
                    naohWeight = (naohMl * specWeight).toFixed(1);
                    
                    // Mother liquor concentration for alkali = × 5
                    const sodaAshMotherLiquor = 20 * 5;
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">NaOH ${alkaliType}°Bé</div>
                                <div class="text-xs text-gray-500">ρ=${specWeight}</div>
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${naohMl} ml/l</div>
                                <div class="text-xs text-blue-600">= ${naohWeight} g/l</div>
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohMl) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                }
            } else if (method === 'sodium-silicate') {
                // Method B
                document.getElementById('dyeConcB').textContent = formatNumber(totalDye);
                const silicateConc = document.getElementById('silicateConc').value;
                const silicateData = sodiumSilicateDataB[silicateConc];
                const naohMl38 = getNaOHForSodiumSilicate(totalDye, silicateData);
                
                const naohConc = document.getElementById('naohConcB').value;
                const naohData = getNaOHData('B');
                
                let naohAmount, naohUnit, naohWeight, naohLabel, naohInfo, naohWeightInfo;
                
                // Mother liquor concentration for alkali = × 5
                const silicateMotherLiquor = silicateData.gl * 5;
                
                if (naohConc === 'custom') {
                    const customBaume = parseInt(document.getElementById('customBaumeB').value) || 38;
                    naohAmount = (naohMl38 * 441.0 / naohData.contentGl).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * naohData.specWeight).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = `NaOH ${customBaume}°Bé`;
                    naohInfo = `<div class="text-xs text-gray-500">ρ=${naohData.specWeight}</div>`;
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(silicateMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohAmount) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                } else if (naohConc === 'flakes') {
                    naohAmount = (naohMl38 * 441.0 / 1000).toFixed(1);
                    const naohMotherLiquor = parseFloat(naohAmount) * 5;
                    naohUnit = 'g/l';
                    naohWeight = naohAmount;
                    naohLabel = 'NaOH Flakes';
                    naohInfo = '';
                    naohWeightInfo = '';
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(silicateMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">${naohLabel}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(naohMotherLiquor * alkaliSol)}</td>
                        </tr>
                    `;
                } else {
                    naohAmount = (naohMl38 * 441.0 / naohData.contentGl).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * naohData.specWeight).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = `NaOH ${naohConc}°Bé`;
                    naohInfo = `<div class="text-xs text-gray-500">ρ=${naohData.specWeight}</div>`;
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${(silicateMotherLiquor * alkaliSol).toFixed(2)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${naohAmount} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${(naohWeightMotherLiquor * alkaliSol).toFixed(2)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${(parseFloat(naohAmount) * 5 * alkaliSol).toFixed(2)} ml)</div>
                            </td>
                        </tr>
                    `;
                }
            } else if (method === 'modified-silicate') {
                // Method C
                document.getElementById('dyeConcC').textContent = formatNumber(totalDye);
                const silicateConc = document.getElementById('silicateConcC').value;
                const silicateData = sodiumSilicateDataC[silicateConc];
                const naohMl38 = getNaOHForSodiumSilicate(totalDye, silicateData);
                
                const naohConc = document.getElementById('naohConcC').value;
                const naohData = getNaOHData('C');
                
                let naohAmount, naohUnit, naohWeight, naohLabel, naohInfo, naohWeightInfo;
                
                // Mother liquor concentration for alkali = × 5
                const silicateMotherLiquor = silicateData.gl * 5;
                
                if (naohConc === 'custom') {
                    const customBaume = parseInt(document.getElementById('customBaumeC').value) || 38;
                    naohAmount = (naohMl38 * 441.0 / naohData.contentGl).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * naohData.specWeight).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = `NaOH ${customBaume}°Bé`;
                    naohInfo = `<div class="text-xs text-gray-500">ρ=${naohData.specWeight}</div>`;
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${(silicateMotherLiquor * alkaliSol).toFixed(2)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${naohAmount} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${(naohWeightMotherLiquor * alkaliSol).toFixed(2)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${(parseFloat(naohAmount) * 5 * alkaliSol).toFixed(2)} ml)</div>
                            </td>
                        </tr>
                    `;
                } else if (naohConc === 'flakes') {
                    naohAmount = (naohMl38 * 441.0 / 1000).toFixed(1);
                    const naohMotherLiquor = parseFloat(naohAmount) * 5;
                    naohUnit = 'g/l';
                    naohWeight = naohAmount;
                    naohLabel = 'NaOH Flakes';
                    naohInfo = '';
                    naohWeightInfo = '';
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${(silicateMotherLiquor * alkaliSol).toFixed(2)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">${naohLabel}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${naohAmount} ${naohUnit}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${(naohMotherLiquor * alkaliSol).toFixed(2)}</td>
                        </tr>
                    `;
                } else {
                    naohAmount = (naohMl38 * 441.0 / naohData.contentGl).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * naohData.specWeight).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = `NaOH ${naohConc}°Bé`;
                    naohInfo = `<div class="text-xs text-gray-500">ρ=${naohData.specWeight}</div>`;
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">Sodium Silicate ${silicateConc}°Bé</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${silicateData.gl} g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${(silicateMotherLiquor * alkaliSol).toFixed(2)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${naohAmount} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${(naohWeightMotherLiquor * alkaliSol).toFixed(2)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${(parseFloat(naohAmount) * 5 * alkaliSol).toFixed(2)} ml)</div>
                            </td>
                        </tr>
                    `;
                }
            } else if (method === 'tropical-region') {
                // Method D - Tropical Region
                document.getElementById('dyeConcD').textContent = formatNumber(totalDye);
                const naohCc50 = getNaOHForTropicalRegion(totalDye); // cc/l for 50% NaOH
                
                const naohConc = document.getElementById('naohConcD').value;
                const naohData = getNaOHData('D');
                
                let naohAmount, naohUnit, naohWeight, naohLabel, naohInfo, naohWeightInfo;
                
                // Mother liquor concentration for alkali = × 5
                const sodaAshMotherLiquor = 20 * 5;
                
                if (naohConc === 'custom') {
                    const customBaume = parseInt(document.getElementById('customBaumeD').value) || 50;
                    // Convert from 50% base (cc/l) to custom concentration
                    naohAmount = (naohCc50 * 766.5 / naohData.contentGl).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * naohData.specWeight).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = `NaOH ${customBaume}°Bé`;
                    naohInfo = `<div class="text-xs text-gray-500">ρ=${naohData.specWeight}</div>`;
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohAmount) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                } else if (naohConc === 'flakes') {
                    // Convert cc/l to g/l: cc * ρ(50%) = cc * 1.530, then convert to pure NaOH: * 0.501
                    naohAmount = (naohCc50 * 1.530 * 0.501).toFixed(1);
                    const naohMotherLiquor = parseFloat(naohAmount) * 5;
                    naohUnit = 'g/l';
                    naohWeight = naohAmount;
                    naohLabel = 'NaOH Flakes';
                    naohInfo = '';
                    naohWeightInfo = '';
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm font-medium">${naohLabel}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(naohMotherLiquor * alkaliSol)}</td>
                        </tr>
                    `;
                } else if (naohConc === '50') {
                    // Use directly from table (cc/l)
                    naohAmount = naohCc50.toFixed(1);
                    naohUnit = 'ml/l';
                    // Convert cc to g: cc * ρ(50%) = cc * 1.530
                    naohWeight = (naohCc50 * 1.530).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = 'NaOH 50°Bé';
                    naohInfo = '<div class="text-xs text-gray-500">ρ=1.530</div>';
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohAmount) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                } else {
                    // 38°Bé: Convert from 50% cc/l base
                    naohAmount = (naohCc50 * 766.5 / 441.0).toFixed(1);
                    naohUnit = 'ml/l';
                    naohWeight = (naohAmount * 1.357).toFixed(1);
                    const naohWeightMotherLiquor = parseFloat(naohWeight) * 5;
                    naohLabel = 'NaOH 38°Bé';
                    naohInfo = '<div class="text-xs text-gray-500">ρ=1.357</div>';
                    naohWeightInfo = `<div class="text-xs text-blue-600">= ${naohWeight} g/l</div>`;
                    
                    tbody.innerHTML = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 text-sm">Soda Ash</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50 text-sm">20 g/l</td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold text-sm number-display text-right">${formatNumber(sodaAshMotherLiquor * alkaliSol)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-3 sm:px-4 py-2">
                                <div class="text-sm font-medium">${naohLabel}</div>
                                ${naohInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-amber-50">
                                <div class="text-sm">${formatNumber(parseFloat(naohAmount))} ${naohUnit}</div>
                                ${naohWeightInfo}
                            </td>
                            <td class="border border-gray-200 px-3 sm:px-4 py-2 bg-emerald-50 font-semibold">
                                <div class="text-sm number-display text-right">${formatNumber(naohWeightMotherLiquor * alkaliSol)} g</div>
                                <div class="text-xs text-blue-600 text-right">(${formatNumber(parseFloat(naohAmount) * 5 * alkaliSol)} ml)</div>
                            </td>
                        </tr>
                    `;
                }
            }
            
            // Update work order after calculation
            updateWorkOrder();
        }

        // Update Work Order Summary
        function updateWorkOrder() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('woDate').textContent = dateStr;
            
            // Customer information
            const customer = document.getElementById('customerName')?.value || '-';
            const color = document.getElementById('colorName')?.value || '-';
            const fabricType = document.getElementById('fabricType')?.value || '-';
            const orderNo = document.getElementById('orderNo')?.value || '-';
            
            document.getElementById('woCustomer').textContent = customer;
            document.getElementById('woColor').textContent = color;
            document.getElementById('woFabricType').textContent = fabricType;
            document.getElementById('woOrderNo').textContent = orderNo;
            
            const mode = document.querySelector('input[name="fabricMode"]:checked').value;
            let fabricQty;
            if (mode === 'direct') {
                fabricQty = parseFloat(document.getElementById('fabricQuantity').value) || 0;
            } else {
                const weight = parseFloat(document.getElementById('fabricWeight').value) || 0;
                const length = parseFloat(document.getElementById('fabricLength').value) || 0;
                fabricQty = weight * length / 1000;
            }
            document.getElementById('woFabric').textContent = formatNumber(fabricQty) + ' kg';
            
            const pickUp = parseFloat(document.getElementById('pickUp').value) || 0;
            document.getElementById('woPickup').textContent = pickUp + '%';
            
            const method = document.getElementById('alkaliMethod').value;
            const methodNames = {
                'silicate-free': 'A. Silicate-Free',
                'sodium-silicate': 'B. Sodium Silicate',
                'modified-silicate': 'C. Modified Sodium Silicate',
                'tropical-region': 'D. Silicate-Free (Tropical)'
            };
            document.getElementById('woMethod').textContent = methodNames[method];
            
            // Calculate theoretical solution
            const theoretical = fabricQty * pickUp / 100;
            const theoreticalDye = theoretical * 4 / 5;
            const theoreticalAlkali = theoretical * 1 / 5;
            
            // Get actual solutions
            const dyeSol = parseFloat(document.getElementById('dyeSolution').value) || 0;
            const alkaliSol = parseFloat(document.getElementById('alkaliSolution').value) || 0;
            const totalActual = dyeSol + alkaliSol;
            
            // Calculate differences
            const dyeDiff = dyeSol - theoreticalDye;
            const alkaliDiff = alkaliSol - theoreticalAlkali;
            const totalDiff = totalActual - theoretical;
            
            document.getElementById('woTotalSol').innerHTML = `
                <div>${formatNumber(theoretical)} ltr</div>
            `;
            document.getElementById('woTheoreticalNote').innerHTML = `
                <span>Dye ${formatNumber(theoreticalDye)}</span>
                <span>Alkali ${formatNumber(theoreticalAlkali)}</span>
            `;
            document.getElementById('woDyeSol').innerHTML = `
                <div>${formatNumber(dyeSol)} ltr</div>
                <div class="text-xs ${dyeDiff >= 0 ? 'text-green-600' : 'text-red-600'}">(${dyeDiff >= 0 ? '+' : ''}${formatNumber(dyeDiff)})</div>
            `;
            document.getElementById('woAlkaliSol').innerHTML = `
                <div>${formatNumber(alkaliSol)} ltr</div>
                <div class="text-xs ${alkaliDiff >= 0 ? 'text-green-600' : 'text-red-600'}">(${alkaliDiff >= 0 ? '+' : ''}${formatNumber(alkaliDiff)})</div>
            `;
            
            // Populate dye table
            const dyeTableBody = document.getElementById('woDyeTable');
            dyeTableBody.innerHTML = '';
            
            const dyeInputs = document.querySelectorAll('.dye-recipe');
            const dyeNames = document.querySelectorAll('#dyeTableBody tr:not(.bg-gray-100):not(.bg-blue-50) input[type="text"]');
            let totalDyeConc = 0;
            
            dyeInputs.forEach((input, i) => {
                const recipe = parseFloat(input.value) || 0;
                if (recipe > 0) {
                    const name = dyeNames[i]?.value || `Dye ${i+1}`;
                    const motherLiquorConc = recipe * 1.25;
                    const quantity = motherLiquorConc * dyeSol;
                    totalDyeConc += recipe;
                    dyeTableBody.innerHTML += `
                        <tr>
                            <td class="border border-gray-300 px-2 sm:px-3 py-2">${name}</td>
                            <td class="border border-gray-300 px-2 sm:px-3 py-2">${formatNumber(recipe)}</td>
                            <td class="border border-gray-300 px-2 sm:px-3 py-2 font-semibold">${formatNumber(quantity)}</td>
                        </tr>
                    `;
                }
            });
            
            // Add total dye row
            dyeTableBody.innerHTML += `
                <tr class="bg-gray-100 font-bold">
                    <td class="border border-gray-300 px-2 sm:px-3 py-2"></td>
                    <td class="border border-gray-300 px-2 sm:px-3 py-2">Total: ${formatNumber(totalDyeConc)} g/l</td>
                    <td class="border border-gray-300 px-2 sm:px-3 py-2"></td>
                </tr>
            `;
            
            // Add auxiliaries
            const auxInputs = document.querySelectorAll('.aux-recipe');
            const auxNames = document.querySelectorAll('#dyeTableBody tr.bg-blue-50 ~ tr input[type="text"]');
            
            auxInputs.forEach((input, i) => {
                const recipe = parseFloat(input.value) || 0;
                if (recipe > 0) {
                    const name = auxNames[i]?.value || `Auxiliary ${i+1}`;
                    const motherLiquorConc = recipe * 1.25;
                    const quantity = motherLiquorConc * dyeSol;
                    dyeTableBody.innerHTML += `
                        <tr class="bg-blue-50">
                            <td class="border border-gray-300 px-2 sm:px-3 py-2">${name}</td>
                            <td class="border border-gray-300 px-2 sm:px-3 py-2">${formatNumber(recipe)}</td>
                            <td class="border border-gray-300 px-2 sm:px-3 py-2 font-semibold">${formatNumber(quantity)}</td>
                        </tr>
                    `;
                }
            });
            
            // Populate alkali table from the existing alkali calculation
            const alkaliTableBody = document.getElementById('woAlkaliTable');
            const sourceAlkaliTable = document.getElementById('alkaliTableBody');
            alkaliTableBody.innerHTML = sourceAlkaliTable.innerHTML;
        }

        // Initialize
        updateRecipeList();
        calculate();
        updateWorkOrder();
    </script>
</body>
</html>